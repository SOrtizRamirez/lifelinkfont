import"./script-BAeR12OA.js";const u=window.API_BASE||`http://${location.hostname}:3000`;async function b(o){const e=await fetch(`${u}/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok){const t=await e.text();throw new Error(`Error al crear contacto de emergencia: ${e.status} ${t}`)}return e.json()}async function $({id:o,relation:e,phone:t,email:n,fullname:a,limit:c=10,offset:r=0}={}){const i=new URLSearchParams;o&&i.set("id",o),e&&i.set("relation",e),t&&i.set("phone",t),n&&i.set("email",n),a&&i.set("fullname",a),i.set("limit",c),i.set("offset",r);const d=await fetch(`${u}/?${i.toString()}`);if(!d.ok){const E=await d.text();throw new Error(`Error al listar contactos de emergencia: ${d.status} ${E}`)}return d.json()}async function w(o,e){const t=await fetch(`${u}/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const n=await t.text();throw new Error(`Error al actualizar contacto de emergencia: ${t.status} ${n}`)}return t.json()}async function I(o){const e=await fetch(`${u}/${o}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!e.ok){const t=await e.text();throw new Error(`Error al eliminar contacto de emergencia: ${e.status} ${t}`)}return e.json()}const h="https://lifelinkback.onrender.com",f=localStorage.getItem("token");f||(location.href="index.html");let g=null,s=null,l="";async function p(){const o=await fetch(`${h}/patients/me`,{headers:{Authorization:"Bearer "+f}}),{data:e}=await o.json();g=e.id,l=`${location.origin}/qr.html?id=${encodeURIComponent(e.qr_identifier)}`,document.getElementById("me").innerHTML=`
      <p><b>Nombre:</b> ${e.name||""} ${e.last_name||""}</p>
      <p><b>Numero de Documento:</b> ${e.identity_document}</p>
      <p><b>Sangre:</b> ${e.blood_type||"-"}</p>
      <p><b>Alergias:</b> ${e.allergies||"-"}</p>
      <p><b>Enfermedades:</b> ${e.medical_conditions||"-"}</p>
      <p><b>Medicamentos:</b> ${e.current_medications||"-"}</p>
    `,document.getElementById("qr-link").innerHTML=`
      <p><b>Enlace de tu QR:</b> <a href="${l}" target="_blank">${l}</a></p>
    `}async function m(){const o=document.getElementById("emergency-list");o.innerHTML="<p>Cargando...</p>";try{const e=await $({id:g,limit:100});if(!e.data||e.data.length===0){o.innerHTML="<p>No hay contactos registrados.</p>";return}o.innerHTML="",e.data.forEach(t=>{if(s===t.contact_id){const n=document.createElement("div");n.className="emergency-contact",n.style.marginBottom="16px",n.innerHTML=`
            <input type="text" id="edit-fullname" value="${t.fullname}" placeholder="Nombre Completo" required>
            <input type="text" id="edit-relation" value="${t.relation||""}" placeholder="Relación" required>
            <input type="text" id="edit-phone" value="${t.phone||""}" placeholder="Teléfono">
            <input type="email" id="edit-email" value="${t.email||""}" placeholder="Correo">
            <button class="save-edit" data-id="${t.contact_id}">Guardar</button>
            <button class="cancel-edit">Cancelar</button>
          `,o.appendChild(n),n.querySelector(".save-edit").onclick=async()=>{const a=n.querySelector("#edit-fullname").value.trim(),c=n.querySelector("#edit-relation").value.trim(),r=n.querySelector("#edit-phone").value.trim(),i=n.querySelector("#edit-email").value.trim();if(!a||!c){alert("Nombre completo y relación son obligatorios");return}try{await w(t.contact_id,{fullname:a,relation:c,phone:r,email:i}),s=null,m()}catch(d){alert("Error al actualizar: "+d.message)}},n.querySelector(".cancel-edit").onclick=()=>{s=null,m()}}else{const n=document.createElement("div");n.className="emergency-contact",n.style.marginBottom="16px",n.innerHTML=`
            <p><b>Nombre:</b> ${t.fullname}</p>
            <p><b>Relación:</b> ${t.relation||"-"}</p>
            <p><b>Teléfono:</b> ${t.phone||"-"}</p>
            <p><b>Correo:</b> ${t.email||"-"}</p>
            <button class="edit-contact" data-id="${t.contact_id}">Editar</button>
            <button class="delete-contact" data-id="${t.contact_id}">Eliminar</button>
          `,o.appendChild(n),n.querySelector(".edit-contact").onclick=()=>{s=t.contact_id,m()},n.querySelector(".delete-contact").onclick=async()=>{confirm("¿Eliminar este contacto?")&&(await I(t.contact_id),m())}}})}catch{o.innerHTML="<p>Error al cargar contactos</p>"}}document.getElementById("show-add-form").onclick=()=>{document.getElementById("add-form").style.display="block",document.getElementById("show-add-form").style.display="none"};document.getElementById("cancel-add").onclick=()=>{document.getElementById("add-form").style.display="none",document.getElementById("show-add-form").style.display="inline-block",document.getElementById("ec-fullname").value="",document.getElementById("ec-relation").value="",document.getElementById("ec-phone").value="",document.getElementById("ec-email").value=""};document.getElementById("save-contact").onclick=async()=>{const o=document.getElementById("ec-fullname").value.trim(),e=document.getElementById("ec-relation").value.trim(),t=document.getElementById("ec-phone").value.trim(),n=document.getElementById("ec-email").value.trim();if(!o||!e){alert("Nombre completo y relación son obligatorios");return}try{await b({id:g,fullname:o,relation:e,phone:t,email:n}),document.getElementById("add-form").style.display="none",document.getElementById("show-add-form").style.display="inline-block",document.getElementById("ec-fullname").value="",document.getElementById("ec-relation").value="",document.getElementById("ec-phone").value="",document.getElementById("ec-email").value="",m()}catch(a){alert("Error al guardar: "+a.message)}};function y(){const o=document.getElementById("qr");o.innerHTML="",l&&window.QRCode&&new QRCode(o,l)}document.getElementById("rotate").onclick=async()=>{const o=await fetch(`${h}/patients/me/qr`,{method:"POST",headers:{Authorization:"Bearer "+f}}),e=await o.json();if(!o.ok){alert(e.message||"No se pudo rotar");return}const t=e.data.qr_identifier;l=`${location.origin}/qr.html?id=${encodeURIComponent(t)}`;const n=document.createElement("div");n.style.position="fixed",n.style.left="-9999px",document.body.appendChild(n),window.QRCode?(new QRCode(n,{text:l,width:512,height:512}),setTimeout(()=>{const a=n.querySelector("canvas");if(a){const c=a.toDataURL("image/png"),r=document.createElement("a");r.href=c,r.download=`LifeLink_QR_${t}.png`,document.body.appendChild(r),r.click(),r.remove()}n.remove(),p(),y()},50)):(alert("No se encontró la librería QRCode"),p(),y())};document.getElementById("logout").onclick=()=>{localStorage.removeItem("token"),location.href="index.html"};await p();await m();y();
